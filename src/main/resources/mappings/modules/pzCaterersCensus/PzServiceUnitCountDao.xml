<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dhc.rad.modules.pzCaterersCensus.dao.PzServiceUnitCountDao">


    <resultMap id="resultMap" type="com.dhc.rad.modules.pzCaterersCensus.entity.PzServiceUnitCount">
        <!--team中的基本属性-->
        <id column="serviceUnitId" property="SERVICE_UNIT_ID"/>
        <result column="serviceUnitName" property="SERVICE_UNIT_NAME"/>

        <!--关联属性的映射关系-->
        <collection property="pzMenuCountList"
                    ofType="com.dhc.rad.modules.pzCaterersCensus.entity.PzMenuCount"
                    column="{eatDate = EAT_DATE,noEatDate = NO_EAT_DATE,restaurantId = RESTAURANT_ID,serviceUnitId = SERVICE_UNIT_ID}"
                    select="selectMenuCount"
                    javaType="java.util.ArrayList"/>
    </resultMap>

    <select id="selectServiceUnitCount" resultMap="resultMap">
        SELECT
	    po.SERVICE_UNIT_ID,
	    so.`NAME` as SERVICE_UNIT_NAME
        FROM
	    pz_order po
	    LEFT JOIN sys_office so ON po.SERVICE_UNIT_ID = so.ID
        WHERE
	    po.EAT_DATE = #{EAT_DATE}
	    AND po.RESTAURANT_ID = #{restaurantId}
	    AND po.NO_EAT_DATE NOT REGEXP #{noEatDate}
    </select>



    <resultMap id="menuCountMap" type="com.dhc.rad.modules.pzCaterersCensus.entity.PzMenuCount">
        <!--team中的基本属性-->
        <id column="menuId" property="menu_id"/>
        <result column="menuName" property="menu_name"/>
        <result column="menuCount" property="menuCount"/>
    </resultMap>


    <select id="selectMenuCount" resultMap="menuCountMap">
        SELECT
	    po.MENU_ID,
	    pm.MENU_NAME,
	    count( po.MENU_ID ) AS MENU_COUNT
        FROM
	    pz_order po
	    LEFT JOIN pz_menu pm ON po.MENU_ID = pm.ID
        WHERE
	    po.EAT_DATE = #{EAT_DATE}
	    AND po.RESTAURANT_ID = #{restaurantId}
	    AND po.NO_EAT_DATE NOT REGEXP #{noEatDate}
	    AND po.SERVICE_UNIT_ID = #{serviceUnitId}
        GROUP BY
	    po.MENU_ID
    </select>









</mapper>